package:
  name: html-pdf-generator
  version: 1.0.0
  description: HTML to PDF generator using Playwright
  target-architecture:
    - all
  copyright:
    - license: MIT
  dependencies:
    runtime:
      - nodejs-24
      - chromium
      - dumb-init
      - ca-certificates-bundle
      - fontconfig
      - freetype
      - harfbuzz
      - nss

environment:
  contents:
    keyring:
      - https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
    repositories:
      - https://packages.wolfi.dev/os
    packages:
      - busybox
      - ca-certificates-bundle
      - nodejs-24
      - npm

pipeline:
  - name: Build application
    runs: |
      # Create destination directories
      APP_DIR="${{targets.destdir}}/usr/lib/html-pdf-generator"
      BIN_DIR="${{targets.destdir}}/usr/bin"
      mkdir -p "${APP_DIR}" "${BIN_DIR}"
      
      # Create package.json
      cat > "${APP_DIR}/package.json" << 'EOFINNER'
      {
        "name": "html-pdf-generator",
        "version": "1.0.0",
        "private": true,
        "dependencies": {
          "express": "^5.1.0",
          "playwright-core": "^1.52.0"
        }
      }
      EOFINNER
      
      # Create server.js
      cat > "${APP_DIR}/server.js" << 'EOFINNER'
      const express = require('express');
      const { chromium } = require('playwright-core');
      const app = express();

      app.use(express.json({limit: '10mb'}));

      app.get('/health', (_, res) => {
          res.sendStatus(200);
      });

      app.post('/generate-pdf', async (req, res) => {
          const { html } = req.body;
          let browser;

          if (!html) {
              return res.status(400).end('HTML content is required');
          }

          try {
              browser = await chromium.launch({ 
                  headless: true,
                  executablePath: '/usr/bin/chromium-browser'
              });
              
              const context = await browser.newContext({
                  offline: true,
                  javaScriptEnabled: false,
                  bypassCSP: false,
                  acceptDownloads: false,
                  ignoreHTTPSErrors: false,
                  serviceWorkers: 'block',
                  permissions: []
              });
              
              const page = await context.newPage();
              await page.setContent(html, { waitUntil: 'networkidle' });

              const buffer = await page.pdf({
                  format: 'A4',
                  printBackground: true,
                  margin: { top: '30px', right: '30px', bottom: '30px', left: '30px' }
              });

              res.set({
                  'Content-Type': 'application/pdf',
                  'Content-Length': buffer.length
              });

              res.end(buffer);
          } catch (error) {
              console.error(error);
              res.status(500).end('An error occurred while generating the PDF');
          } finally {
              if (browser) {
                  await browser.close();
              }
          }
      });

      app.listen(8080, '0.0.0.0', () => console.log('PDF generation service started on port 8080'));
      EOFINNER
      
      # Create executable wrapper
      cat > "${BIN_DIR}/html-pdf-generator" << 'EOFINNER'
      #!/bin/sh
      exec node /usr/lib/html-pdf-generator/server.js "$@"
      EOFINNER
      
      # Make sure the executable has proper permissions
      chmod +x "${BIN_DIR}/html-pdf-generator"
      
      # Install dependencies - THIS HAPPENS ONLY DURING BUILD
      cd "${APP_DIR}"
      npm install --omit=dev --no-package-lock
      
      # Remove npm cache and unnecessary files to keep the APK small
      rm -rf ~/.npm
