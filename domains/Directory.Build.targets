<Project>
    <Target Name="CheckPackageVersions" BeforeTargets="Build">
        <Message Text="Executing CheckPackageVersions target in project: $(MSBuildProjectFullPath)" Importance="High" />

        <ItemGroup>
            <InvalidPackageReference Include="@(PackageReference)">
                <PackageVersion>%(Version)</PackageVersion>
                <IsVersionInvalid>$([System.Text.RegularExpressions.Regex]::IsMatch('%(PackageVersion)', '^(0\.\d+\.\d+(-.*)?|[1-9]\d*\.\d+\.\d+-.*)$'))</IsVersionInvalid>
            </InvalidPackageReference>
        </ItemGroup>

        <Message Text="Package: %(InvalidPackageReference.Identity), Version: %(InvalidPackageReference.PackageVersion), IsVersionInvalid: %(InvalidPackageReference.IsVersionInvalid)" Importance="High" />

        <Error
                Text="The following package(s) have invalid versions (less than 1.0.0 or pre-release versions): @(InvalidPackageReference->'%(Identity) (Version: %(PackageVersion))', ', ')"
                Condition="'@(InvalidPackageReference->WithMetadataValue('IsVersionInvalid', 'True')->Count())' != '0'"
        />
    </Target>
</Project>
