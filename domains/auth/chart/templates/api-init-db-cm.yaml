apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-api-init-db-cm
  namespace: {{ .Release.Namespace }}
  annotations:
    internal.config.kubernetes.io/needsHashSuffix: enabled
data:
  run.sh: |
    pg_isready -U ${PGUSER:-postgres} -h ${PGHOST:-localhost} -p ${PGPORT:-5432}
    cat /sql/API.migrations.sql /sql/API.grants.sql | psql auth-database -U ${PGUSER:-postgres} -p ${PGPORT:-5432} -h ${PGHOST:-localhost} -f -
  API.migrations.sql: |-
{{ .Files.Get "API.migrations.sql" | indent 4 }}
  API.grants.sql: |
    START TRANSACTION;
    REVOKE ALL ON ALL TABLES IN SCHEMA public FROM auth;
    GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO auth;
    COMMIT;
