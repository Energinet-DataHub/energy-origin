name: Build

on:
  workflow_call:
    inputs:
      dry-run:
        description: "An indication of whether to commit/publish results"
        required: true
        type: string
      is-dependabot:
        description: "An indication of a dependabot pull request"
        required: true
        type: string

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET Core SDK
        uses: actions/setup-dotnet@v1.7.2
        with:
          dotnet-version: '8.0.x'

      - uses: leonardochaia/dotnet-affected-action@v1
        id: dotnet_affected
        with:
          from: ${{ github.event.pull_request.head.sha }}
          to: ${{ github.event.pull_request.base.sha }}

      - name: Parse Affected Projects
        id: set-matrix
        run: |
          affected_projects=$(grep '<ProjectReference' affected.proj | sed 's/.*Include="\([^"]*\)".*/\1/' | tr '\n' ' ')
          json_matrix=$(echo "$affected_projects" | jq -R -s -c 'split(" ") | map(select(test("^\\s*$") | not)) | map({"project": .})')
          echo "Affected projects: $affected_projects"
          echo "JSON matrix: $json_matrix"
          echo "$json_matrix" > matrix.json

      - name: Upload matrix file
        uses: actions/upload-artifact@v2
        with:
          name: matrix
          path: matrix.json
