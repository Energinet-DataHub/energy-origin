name: Build domain

on:
  workflow_call: {}

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      domains: ${{ env.domains }}
      projects: ${{ env.projects }}

    steps:
      - uses: actions/checkout@v3

      - name: Validate required domain structure
        shell: bash
        run: |
          function required_folder {
            [ -d "$1" ] || { printf '::error title=Missing folder::%s\n' "$1"; exit 1; }
          }

          function required_file {
            [ -f "$1" ] || { printf '::error title=Missing file::%s\n' "$1"; exit 1; }
          }

          find domains -mindepth 1 -maxdepth 1 -type d | while read domain; do
            required_folder "$domain/.devcontainer"
            required_file "$domain/.devcontainer/Dockerfile"
            required_file "$domain/.devcontainer/devcontainer.json"
            required_file "$domain"/*.sln
            if [ ! -f "$domain/configuration.yaml" ]; then
              find "$domain" -name configuration.yaml -mindepth 2 -maxdepth 2 -type f | read || { printf '::error title=Missing file::%s/configuration.yaml\n' "$domain"; exit 1; }
            fi
          done

      - uses: CodeReaper/find-diff-action@v3
        id: diff
        with:
          paths: domains/*/

      - name: Set default matrices
        shell: bash
        run: |
          echo "domains=[]" >> "$GITHUB_ENV"
          echo "projects=[]" >> "$GITHUB_ENV"

      - name: Build relevant domain/project matrices
        if: ${{ steps.diff.outputs.list != '' }}
        shell: bash
        env:
          LIST: ${{ steps.diff.outputs.list }}
        run: |
          matrix=$(while read domain; do
            [ -f "$domain/domain.json" ] || echo "{}" > "$domain/domain.json"
            echo '{}' > "$domain/default.domain.json"
            [ -f "$domain/global.json" ] || cp "$domain/../../global.json" "$domain/global.json"
            settings=$(jq -srec '.[0] * .[1] * .[2] | .path=$path' --arg path "$domain" "$domain/default.domain.json" "$domain/domain.json" "$domain/global.json")

            sdk=$(printf '%s' "$settings" | jq -rce '.sdk.version')
            projects=$(find "$domain" -mindepth 3 -maxdepth 3 -name "*.csproj" -exec dirname {} \; | egrep -v '[^\/]*/[^\/]*/Shared/[^\/]*' | egrep -v 'Tests$' | while read directory; do printf '{"path":"%s","dotnetVersion":"%s"}' "$directory" "$sdk"; done | jq -sc '.')

            printf '{"domain":%s,"projects":%s}' "$settings" "$projects"
          done <<< $LIST | jq -sc '.')

          echo '::group::Matrix'
          echo "$matrix" | jq -r '.'
          echo '::endgroup::'

          domains=$(printf "$matrix" | jq -cr '[.[].domain] | unique')
          echo "domains=$domains" >> "$GITHUB_ENV"

          projects=$(printf "$matrix" | jq '.[].projects[]' | jq -scr '. | unique')
          echo "projects=$projects" >> "$GITHUB_ENV"

      - name: Relevant domains
        shell: bash
        run: |
          echo '::group::Raw'
          printf '${{ env.domains }}\n'
          echo '::endgroup::'
          printf '${{ env.domains }}' | jq -r '.'

      - name: Relevant projects
        shell: bash
        run: |
          echo '::group::Raw'
          printf '${{ env.projects }}\n'
          echo '::endgroup::'
          printf '${{ env.projects }}' | jq -r '.'

  build-projects:
    name: Build projects
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ needs.setup.outputs.projects != '[]' }}
    strategy:
      matrix:
        build: ${{ fromJson(needs.setup.outputs.projects) }}
    steps:
      - uses: actions/checkout@v3

      - name: Resolve
        shell: bash
        id: resolver
        env:
          PROJECT: ${{ matrix.build.path }}
          PR: ${{ github.event.pull_request.number }}
        run: |
          docker="$PROJECT/Dockerfile"
          service=$(dirname "$PROJECT")
          domain=$(dirname "$service")
          overrides="${service}/chart-overrides.yaml"
          name=$(basename $(yq '.name' "$overrides"))

          tag=$(yq '.version' "$overrides")
          tag=$(sh ./.github/tooling/semver.sh "$tag" "$PR")

          dotnet=${{ matrix.build.dotnetVersion }}

          {
            echo "service=${service}"
            echo "project=${PROJECT}"
            echo "docker=${docker}"
            echo "domain=${domain}"
            echo "tag=${tag}"
            echo "name=${name}"
            echo "dotnet=${dotnet::${#dotnet}-2}"
          } >> $GITHUB_OUTPUT

      - name: Pin dotnet version
        shell: bash
        run: echo '{"sdk":{"rollForward":"disable","version":"${{ matrix.build.dotnetVersion }}"}}' > "${{ steps.resolver.outputs.domain }}/global.json"

      - name: Test and lint image
        uses: ./.github/actions/dotnet-validate-domain
        with:
          solution-file-folder: ${{ steps.resolver.outputs.service }}
          dotnet-version: ${{ matrix.build.dotnetVersion }}

      - name: Build image
        uses: ./.github/actions/build-and-push-container
        with:
          dockerfile: ${{ steps.resolver.outputs.docker }}
          image-name: ${{ steps.resolver.outputs.name }}
          image-tag: ${{ steps.resolver.outputs.tag }}
          docker-context: ${{ steps.resolver.outputs.domain }}
          dry-run: github.event_name == 'push' && github.ref_name == 'main' || github.event_name == 'pull_request' && startsWith(github.event.pull_request.head.ref, 'preview/')
          build-args: |
            SDK_VERSION=${{ matrix.build.dotnetVersion }}
            RUNTIME_VERSION=${{ steps.resolver.outputs.dotnet }}

  update-environment:
    name: Update environment
    runs-on: ubuntu-latest
    needs:
      - setup
      - build-projects
    concurrency: commits-base-environment
    strategy:
      max-parallel: 1
      matrix:
        build: ${{ fromJson(needs.setup.outputs.domains) }}
    steps:
      - uses: actions/checkout@v3

      - name: Update environment
        uses: ./.github/actions/update-base-environment
        with:
          configuration: ${{ matrix.build.path }}/configuration.yaml
          deploy_key: ${{ secrets.DEPLOY_KEY_BASE_ENVIRONMENT }}
          dry_run: github.event_name == 'push' && github.ref_name == 'main' || github.event_name == 'pull_request' && startsWith(github.event.pull_request.head.ref, 'preview/')
