name: Auto-create PR - data sync

on:
  push:
    branches:
      - "**"
      - "!main"
    paths:
      - .github/workflows/auto-create-pr-data-sync.yaml
      # - domains/data-sync/**

jobs:
  autocreate-pr:
    name: Auto-create PR
    runs-on: ubuntu-latest
    steps:
      - name: Check for message [TAG]
        id: check
        shell: bash
        run: |
          echo "Checking branch '${{ github.ref_name }}' commit message:"
          echo "${{ github.event.head_commit.message }}"

          echo "::set-output name=relevant::false"
          if grep -q "[AUTO-PR]" <<< "${{ github.event.head_commit.message }}"; then
            echo "::set-output name=relevant::true"
          fi

      - uses: actions/checkout@v3
        # if: ${{ steps.check.outputs.relevant == 'true' }}
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY_ENERGY_ORIGIN }}
          fetch-depth: 0

      - name: Create Pull Request
        # if: ${{ steps.check.outputs.relevant == 'true' }}
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # gh pr list --state open --head '${{ github.ref_name }}' --json headRefName | grep -Eq '${{ github.ref_name }}' && exit 0
          # gh pr create --base main --title "Update chart for '${{ github.ref_name }}'" --body ''

          git config --local user.name 'github-actions'
          git config --local user.email '41898282+github-actions[bot]@users.noreply.github.com'

          git commit -m 'PR created' --allow-empty
          git push --set-upstream origin '${{ github.ref_name }}'