name: Build Subsystems

on:
  workflow_call:
    inputs:
      dry-run:
        description: "An indication of whether to commit/publish results"
        required: true
        type: string
      is-dependabot:
        description: "An indication of a dependabot pull request"
        required: true
        type: string

jobs:
  find-diff:
    runs-on: ubuntu-latest
    outputs:
      affected-projects: ${{ steps.dotnet_affected.outputs.affected }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # We need the full history to compare commits

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.401'  # Adjust this to your .NET version

      - name: Run dotnet-affected
        uses: leonardochaia/dotnet-affected-action@v1
        id: dotnet_affected
        with:
          from: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || 'origin/main' }}
          to: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: Debug output
        run: |
          echo "Affected projects: ${{ steps.dotnet_affected.outputs.affected }}"

  build:
    needs: find-diff
    runs-on: ubuntu-latest
    if: ${{ needs.find-diff.outputs.affected-projects != '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build affected projects
        run: dotnet build --configuration Release affected.proj

  test:
    needs: find-diff
    runs-on: ubuntu-latest
    if: ${{ needs.find-diff.outputs.affected-projects != '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test affected projects
        run: dotnet test --no-restore --verbosity normal affected.proj

  deploy-images:
    needs: [find-diff, build, test]
    runs-on: ubuntu-latest
    concurrency: commits-base-environment
    if: ${{ inputs.is-dependabot == 'false' && needs.find-diff.outputs.affected-projects != '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update environment
        uses: Energinet-DataHub/acorn-actions/actions/update-base-environment@v2
        with:
          configurations: affected.proj
          deploy_key: ${{ secrets.DEPLOY_KEY_BASE_ENVIRONMENT }}
          dry_run: ${{ inputs.dry-run }}
