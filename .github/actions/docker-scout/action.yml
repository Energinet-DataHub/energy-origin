name: Scans docker container in ghcr.io
description: |
  This action scans an image in ghcr.io, generates an SBOM, reports on its vulnerabilities, and can upload a SARIF result to GitHub. It prevents critical or high severity vulnerabilities from proceeding.

inputs:
  image-name:
    description: "The full image name excluding ghcr.io/<my_container>"
    required: true
  image-tag:
    description: The image tag
    required: true
  upload-sarif:
    description: Determines if the SARIF result is uploaded
    required: true

runs:
  using: composite
  steps:
    - name: Resolve container image name
      shell: bash
      run: echo "LOWERCASED=$(echo 'ghcr.io/${{ github.repository_owner }}/${{ inputs.image-name }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

    - name: Log in to the Container registry
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ github.token }}
        ecr: false

    - name: Generate SBOM and Scan image
      uses: docker/scout-action@v1
      id: scout
      with:
        command: sbom,cves,recommendations
        image: ${{ env.LOWERCASED }}:${{ inputs.image-tag }}
        only-severities: critical,high
        ignore-base: true
        ignore-unchanged: true
        write-comment: true
        github-token: ${{ github.token }}
        sarif-file: sarif.output.json

    - name: Print scanning summary
      shell: bash
      run: |
        pipx install sarif-tools
        {
          echo \`\`\`
          sarif summary "${{ steps.scout.outputs.sarif }}"
          echo \`\`\`
        } >> $GITHUB_STEP_SUMMARY

    - name: Upload sarif report
      if: ${{ inputs.upload-sarif == 'true' }}
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: sarif.output.json
        category: grype
