name: 'Build and Test Transfer System'
description: 'A reusable action to build and test the transfer system.'

inputs:
  dry-run:
    description: 'Indicates whether to perform a dry run.'
    required: true
    default: 'false'

  is-dependabot:
    description: 'Indicates if the workflow is triggered by Dependabot.'
    required: true
    default: 'false'

runs:
  using: 'composite'
  steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Fetch Main Branch
      shell: bash
      run: git fetch origin main

    - name: Set Base Path
      id: set-path
      shell: bash
      run: echo "::set-output name=base-path::domains/transfer"

    - name: Determine Changed Files
      id: get-changed-files
      shell: bash
      run: |
        echo "Detecting changed files in the transfer solution..."
        changed_files=$(git diff --name-only origin/main...HEAD -- 'domains/transfer/*')
        echo "::set-output name=changed-files::$changed_files"

    - name: Test Solution
      uses: ./.github/actions/test-solution
      with:
        base-path: ${{ steps.set-path.outputs.base-path }}
        dotnet-version: '8.0.204'

    - name: Transfer API
      if: contains(steps.get-changed-files.outputs['changed-files'], 'Transfer.API')
      uses: ./.github/actions/build-docker-image
      with:
        solution: domains/transfer/Transfer.sln
        project: domains/transfer/Transfer.API/API/API.csproj
        configuration: domains/transfer/Transfer.API/configuration.yaml
        migrations: domains/transfer/migrations/API.sql
        dry-run: true
        sdk-version: '8.0.204'
        runtime-version: '8.0.4'

    - name: Transfer Claim Automation
      if: contains(steps.get-changed-files.outputs['changed-files'], 'ClaimAutomation')
      uses: ./.github/actions/build-docker-image
      with:
        solution: domains/transfer/Transfer.sln
        project: domains/transfer/ClaimAutomation/Worker/Worker.csproj
        configuration: domains/transfer/ClaimAutomation/configuration.yaml
        migrations: domains/transfer/migrations/API.sql
        dry-run: true

    - name: Transfer Agreement Automation
      if: contains(steps.get-changed-files.outputs['changed-files'], 'TransferAgreementAutomation')
      uses: ./.github/actions/build-docker-image
      with:
        solution: domains/transfer/Transfer.sln
        project: domains/transfer/ClaimAutomation/Worker/Worker.csproj
        configuration: domains/transfer/ClaimAutomation/configuration.yaml
        migrations: domains/transfer/migrations/API.sql
        dry-run: true

    - name: Determine Workflow Success
      shell: bash
      run: |
        if [[ "${{ steps.test-solution.outputs.result }}"!= "success" ]]; then
          echo "One or more tasks failed."
          exit 1
        else
          echo "All tasks completed successfully."
        fi
