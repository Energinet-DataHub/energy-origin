name: 'Build and Test authorization'
description: 'A reusable action to build and test the transfer system.'
inputs:
  dry-run:
    description: 'Indicates whether to perform a dry run.'
    required: true
    default: 'false'
  is-dependabot:
    description: 'Indicates if the workflow is triggered by Dependabot.'
    required: true
    default: 'false'

runs:
  using: 'composite'
  steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Fetch Main Branch
      shell: bash
      run: git fetch origin main

    - name: Set Base Path
      id: set-path
      shell: bash
      run: echo "::set-output name=base-path::domains/authorization"

    - name: Determine Changed Files
      id: get-changed-files
      shell: bash
      run: |
        echo "Detecting changed files in the authorization solution..."
        changed_files=$(git diff --name-only origin/main...HEAD -- 'domains/authorization/*')
        echo "::set-output name=changed-files::$changed_files"

    - name: Test Solution
      uses: ./.github/actions/test-solution
      with:
        base-path: ${{ steps.set-path.outputs.base-path }}
        dotnet-version: '8.0.204'

    - name: Authorization API
      if: contains(steps.get-changed-files.outputs['changed-files'], 'Authorization.API')
      uses: ./.github/actions/build-docker-image
      with:
        solution: domains/authorization/Authorization.sln
        project: domains/authorization/Authorization.API/API/API.csproj
        configuration: domains/authorization/Authorization.API/configuration.yaml
        dry-run: true
        sdk-version: '8.0.204'
        runtime-version: '8.0.4'

    - name: Restore and Test Entire Solution
      shell: bash
      run: |
        dotnet restore ${{ inputs.base-path }}
        dotnet test ${{ inputs.base-path }} --no-restore
        # Check the exit code of the last command
        if [ $? -eq 0 ]; then
          echo "::set-output name=result::success"
        else
          echo "::set-output name=result::failure"
        fi
