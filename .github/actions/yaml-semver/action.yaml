name: Yaml - Get semver plus pr
description: |
  Get semver from a path in a yaml file and if PR then append extra values.

inputs:
  yaml-file:
    description: Path to the version file.
    required: true
  yaml-path:
    description: Path inside the version file.
    required: true

outputs:
  semver:
    description: The resulting semver
    value: ${{ steps.output.outputs.version }}

runs:
  using: composite
  steps:
    - name: Guard against non-supported events
      if: ${{ github.event_name != 'push' && github.event_name != 'pull_request' }}
      shell: bash
      run: |
        echo "::error:: Only "push" and "pull_request" events are supported by this action."
        exit 1

    - uses: actions/checkout@v3
      with:
        path: base
        ref: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') && github.ref || github.head_ref }}

    - name: Generate semver
      id: output
      shell: bash
      run: |
        cd base
        version=$(yq ".${{ inputs.yaml-path }}" "${{ inputs.yaml-file }}")
        if [ "$GITHUB_EVENT_NAME" = 'push' ] && [ "$GITHUB_REF_NAME" = 'main' ]; then
          version="$version"
        elif [ "$GITHUB_EVENT_NAME" = 'pull_request' ]; then
          version="${version}-pr.${{ github.event.pull_request.number }}-$(git rev-parse --short $GITHUB_SHA)"
        else
          >&2 echo "::error:: Not supported on push to branches other than main"
          exit 1
        fi
        echo "version=${version}" >> $GITHUB_OUTPUT
        echo "version=${version}" >> $GITHUB_ENV
