name: Update B2C
description: Update B2C redirect URLs

inputs:
  azure-tenant-id:
    description: Azure Tenant ID.
    required: true
  azure-client-id:
    description: Azure Client ID.
    required: true
  azure-client-secret:
    description: Azure Client secret.
    required: true
  github-client-id:
    description: Github Client ID.
    required: true
  github-client-secret:
    description: Github Client secret.
    required: true
runs:
  using: composite
  steps:
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: "{ \"clientSecret\": \"${{ inputs.azure-client-secret }}\", \"tenantId\": \"${{ inputs.azure-tenant-id }}\", \"clientId\": \"${{ inputs.azure-client-id }}\"}"
        allow-no-subscriptions: true

    - name: Generate Github token
      uses: Energinet-DataHub/.github/.github/actions/github-create-token@v13
      id: generate_token
      with:
        app_id: ${{ inputs.github-client-id }}
        private_key: ${{ inputs.github-client-secret }}

    - name: Update redirect URLs
      env:
        GH_TOKEN: ${{ steps.generate_token.outputs.token }}
      shell: bash
      run: |
        set -euo pipefail

        urls=(
          https://jwt.io
          http{,s}://localhost:4200/{da,en}/callback
          https://demo.energytrackandtrace.dk/{da,en}/callback
        )

        gh api repos/Energinet-DataHub/eo-base-environment/branches \
          --paginate --jq '.[].name' | tr '[:upper:]' '[:lower:]' |
        while read -r b; do
          case $b in
            preview*)  p=p d=${b#preview}  ;;
            vcluster*) p=v d=${b#vcluster} ;;
            *) continue ;;
          esac
          d=${d//[^0-9a-z]/}
          urls+=(https://energytrackandtrace-dk.$d.$p.acorn-dev.dk/{en,da}/callback)
        done

        body=$(printf '%s\n' "${urls[@]}" | jq -Rs 'split("\n")[:-1]')

        az rest -m PATCH \
          -u "https://graph.microsoft.com/v1.0/applications/${{ env.ettFrontendAppObjectId }}" \
          -H 'Content-Type: application/json' \
          -b "{\"spa\":{\"redirectUris\":$body}}"

        az ad app show --id "${{ env.ettFrontendAppObjectId }}"

