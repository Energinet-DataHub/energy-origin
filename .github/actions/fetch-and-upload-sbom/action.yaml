name: 'Fetch and Upload SBOM'
description: 'Fetches SBOM from GitHub API and uploads it as an artifact'
author: 'Energinet-Datahub'

inputs:
  token:
    description: 'GitHub token with read access to repository contents'
    required: true
    default: ${{ github.token }}
  repository:
    description: 'Repository name with owner (e.g., "owner/repo")'
    required: false
    default: ${{ github.repository }}
  artifact-name:
    description: 'Name of the artifact to upload'
    required: false
    default: 'sbom'
  retention-days:
    description: 'Number of days to retain the artifact'
    required: false
    default: '90'
  compression-level:
    description: 'Compression level for the artifact (0-9)'
    required: false
    default: '6'

outputs:
  artifact-id:
    description: 'The ID of the uploaded artifact'
    value: ${{ steps.upload-sbom.outputs.artifact-id }}
  artifact-url:
    description: 'The URL of the uploaded artifact'
    value: ${{ steps.upload-sbom.outputs.artifact-url }}

runs:
  using: 'composite'
  steps:
    - name: Fetch SBOM from GitHub API
      id: fetch-sbom
      shell: bash
      run: |
        # Parse repository owner and name
        REPO="${{ inputs.repository }}"
        OWNER=$(echo $REPO | cut -d '/' -f 1)
        REPO_NAME=$(echo $REPO | cut -d '/' -f 2)

        echo "Fetching SBOM for $OWNER/$REPO_NAME..."

        # Create directory for SBOM
        mkdir -p sbom_data

        # Fetch SBOM using GitHub API
        HTTP_STATUS=$(curl -s -o sbom_data/sbom.json -w "%{http_code}" \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ inputs.token }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "https://api.github.com/repos/$OWNER/$REPO_NAME/dependency-graph/sbom")

        # Check if the request was successful
        if [ "$HTTP_STATUS" -ne 200 ]; then
          echo "::error::Failed to fetch SBOM. HTTP Status: $HTTP_STATUS"
          cat sbom_data/sbom.json
          exit 1
        fi

        echo "Successfully fetched SBOM for $OWNER/$REPO_NAME"

        # Create a metadata file with information about the SBOM
        cat > sbom_data/metadata.txt << EOF
        Repository: $OWNER/$REPO_NAME
        Fetched at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
        EOF

    - name: Upload SBOM as artifact
      id: upload-sbom
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.artifact-name }}
        path: sbom_data/
        retention-days: ${{ inputs.retention-days }}
        compression-level: ${{ inputs.compression-level }}
