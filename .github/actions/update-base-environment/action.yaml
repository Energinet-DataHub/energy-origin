name: Update base environment
description: ""

inputs:
  env_repository:
    description: The repository containing the environment
    required: false
    default: ${{ github.repository_owner }}/eo-base-environment
  env_branch:
    description: The branch on the environment repository to target.
    required: false
    default: main
  dry_run:
    description: Perform all actions but without committing changes
    required: false
    default: "false"
  app_name:
    description: The name of the app in the environment.
    required: true
  chart_name:
    description: The name of the chart.
    required: true
  chart_version:
    description: The chart version.
    required: true
  deploy_key:
    description: A deploy key that has access to the environment repository.
    required: true

runs:
  using: composite
  steps:
    - name: Checkout base environment repository
      uses: actions/checkout@v3
      with:
        path: base
        repository: ${{ inputs.env_repository }}
        ssh-key: ${{ inputs.deploy_key }}
        ref: main

    - name: Switch branch if not main
      working-directory: base
      shell: bash
      if: ${{ inputs.env_branch != 'main' }}
      run: |
        git fetch
        git checkout ${{ inputs.env_branch }} 2>/dev/null || git checkout -b ${{ inputs.env_branch }}

    - name: Resolve simple app
      shell: bash
      env:
        APP_NAME: ${{ inputs.app_name }}
      run: echo "basefile=k8s/energy-origin-apps/${APP_NAME#eo-}/base/kustomization.yaml" >> $GITHUB_STATE

    - name: Validate simple app file
      working-directory: base
      shell: bash
      run: |
        # Disallow multiple manifests in simple app files
        grep -v '^---' ${{ env.basefile }} >/dev/null

    - name: Update target revision
      uses: Energinet-DataHub/energy-origin/.github/actions/yaml-set@main
      with:
        yaml_file: base/${{ env.basefile }}
        yaml_path: helmCharts[name="${{ inputs.chart_name }}"].version
        value: ${{ inputs.chart_version }}

    - name: Branch - commit changes
      id: commit
      if: ${{ inputs.dry_run != 'true' }}
      uses: EndBug/add-and-commit@v9
      with:
        add: ${{ env.basefile }}
        message: Bump ${{ inputs.app_name }} to new release ${{ inputs.chart_version }}
        new_branch: ${{ inputs.env_branch }}
        push: --force --set-upstream origin ${{ inputs.env_branch }}
        default_author: github_actions
        cwd: base

    - name: Verify changes were pushed
      shell: bash
      if: ${{ inputs.dry_run == 'false' && steps.commit.outputs.pushed == 'false' }}
      run: |
        echo "::error::Nothing was committed or pushed"
        exit 1
