name: Dotnet - Test
description: Runs the dotnet tests

inputs:

  github-token:
    description: GitHub token for authentication.
    required: true

  solution:
    description: Is the path to a solution file.
    required: true

  sdk-version:
    description: Is a complete sdk version in format x.y.zzz
    required: false
    default: ""

  generate-report:
    description: If a test report should be generated.
    required: false
    default: "false"

runs:
  using: composite
  steps:
    - name: Load - global.json
      shell: bash
      run: |
        DIRECTORY=$(dirname '${{ inputs.solution }}')
        test -f "$DIRECTORY/global.json" || exit 0
        echo "DIRECTORY=$DIRECTORY" | tee -a $GITHUB_ENV
        echo "SDK=$(jq -rc '.sdk.version' "$DIRECTORY/global.json")" | tee -a $GITHUB_ENV
    - name: Overwrite - if given optional input
      shell: bash
      run: |
        if [ ! -z "${{ inputs.sdk-version }}" ]; then
          echo "SDK=${{ inputs.sdk-version }}" | tee -a $GITHUB_ENV
        fi

    - name: Fail - if sdk-version is not present
      shell: bash
      run: |
        set +e
        ! test -z "${{ env.SDK }}"

    - name: Test
      continue-on-error: true
      uses: Energinet-DataHub/acorn-actions/actions/dotnet-validate-solution@db7de20897b7df17c1f38632544edefe4db7260a
      with:
        path: ${{ env.DIRECTORY }}
        dotnet-version: ${{ env.SDK }}
        pin-version: true
        generate-report: ${{ inputs.generate-report }}

    - name: Report Test Results
      if: ${{ inputs.generate-report == 'true' }}
      uses: bibipkins/dotnet-test-reporter@v1.4.1
      with:
        github-token: ${{ inputs.github-token }}
        results-path: './**/*.trx'
        comment-title: 'Test Results'
        allow-failed-tests: 'false' # DO NOT SET TO TRUE, UNLESS YOU KNOW WHAT YOU ARE DOING
        show-failed-tests-only: 'true'
        show-test-output: 'true'
